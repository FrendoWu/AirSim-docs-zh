<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>强化学习 - AirSim中文文档</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "\u5f3a\u5316\u5b66\u4e60";
    var mkdocs_page_input_path = "reinforcement_learning.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> AirSim中文文档</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">主页</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">搭建AirSim</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../use_precompiled/">下载场景文件</a>
                </li>
                <li class="">
                    
    <a class="" href="../build_windows/">在Windows上构建</a>
                </li>
                <li class="">
                    
    <a class="" href="../build_linux/">在Linux上构建</a>
                </li>
                <li class="">
                    
    <a class="" href="../unreal_custenv/">创建自定义环境</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">运行AirSim</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../apis/">核心APIs</a>
                </li>
                <li class="">
                    
    <a class="" href="../image_apis/">图像相关APIs</a>
                </li>
                <li class="">
                    
    <a class="" href="../apis_cpp/">C++ APIs</a>
                </li>
                <li class="">
                    
    <a class="" href="../dev_workflow/">开发工作流程</a>
                </li>
                <li class="">
                    
    <a class="" href="../settings/">设置</a>
                </li>
                <li class="">
                    
    <a class="" href="../camera_views/">相机视图</a>
                </li>
                <li class="">
                    
    <a class="" href="../using_car/">汽车相关</a>
                </li>
                <li class="">
                    
    <a class="" href="../remote_control/">遥控器控制</a>
                </li>
                <li class="">
                    
    <a class="" href="../xbox_controller/">XBox控制</a>
                </li>
                <li class="">
                    
    <a class="" href="../steering_wheel_installation/">方向盘控制</a>
                </li>
                <li class="">
                    
    <a class="" href="../multi_vehicle/">多车模式</a>
                </li>
                <li class="">
                    
    <a class="" href="../sensors/">传感器</a>
                </li>
                <li class="">
                    
    <a class="" href="../lidar/">LIDAR</a>
                </li>
                <li class="">
                    
    <a class="" href="../ros/">ROS</a>
                </li>
                <li class="">
                    
    <a class="" href="../playback/">运行日志</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">总体设计</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../design/">架构</a>
                </li>
                <li class="">
                    
    <a class="" href="../code_structure/">代码结构</a>
                </li>
                <li class="">
                    
    <a class="" href="../coding_guidelines/">编码指引</a>
                </li>
                <li class="">
                    
    <a class="" href="../flight_controller/">飞行控制器</a>
                </li>
                <li class="">
                    
    <a class="" href="../simple_flight/">简单的飞行</a>
                </li>
                <li class="">
                    
    <a class="" href="../hello_drone/">无人机之你好世界</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">MavLink和PX4</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../px4_setup/">为AirSim配置PX4</a>
                </li>
                <li class="">
                    
    <a class="" href="../px4_sitl/">PX4之软件在环</a>
                </li>
                <li class="">
                    
    <a class="" href="https://youtu.be/1oY8Qu5maQQ">为Pixhawk加载AirSim</a>
                </li>
                <li class="">
                    
    <a class="" href="https://youtu.be/HNWdYrtw3f0">PX4上配置AirSim</a>
                </li>
                <li class="">
                    
    <a class="" href="https://www.youtube.com/watch?v=d_FyjKDWQfc&feature=youtu.be">调试姿态估计</a>
                </li>
                <li class="">
                    
    <a class="" href="https://github.com/Microsoft/AirSim/wiki/Intercepting-MavLink-messages">拦截MavLink的消息</a>
                </li>
                <li class="">
                    
    <a class="" href="https://github.com/Microsoft/AirSim/wiki/Rapid-Descent-on-PX4-drones">让无人机于PX4中快速下降</a>
                </li>
                <li class="">
                    
    <a class="" href="../px4_build/">构建PX4</a>
                </li>
                <li class="">
                    
    <a class="" href="../px4_logging/">PX4/MavLink日志</a>
                </li>
                <li class="">
                    
    <a class="" href="../log_viewer/">查看MavLink日志</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">升级</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../unreal_upgrade/">更新虚幻引擎</a>
                </li>
                <li class="">
                    
    <a class="" href="../upgrade_apis/">更新APIs</a>
                </li>
                <li class="">
                    
    <a class="" href="../upgrade_settings/">更新设置</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">他人贡献的教程</span>
    <ul class="subnav">
                <li class=" current">
                    
    <a class="current" href="./">强化学习</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#reinforcement-learning-in-airsim">Reinforcement Learning in AirSim</a></li>
    
        <ul>
        
            <li><a class="toctree-l4" href="#disclaimer">Disclaimer</a></li>
        
            <li><a class="toctree-l4" href="#rl-with-car">RL with Car</a></li>
        
            <li><a class="toctree-l4" href="#rl-with-quadrotor">RL with Quadrotor</a></li>
        
            <li><a class="toctree-l4" href="#related">Related</a></li>
        
        </ul>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="https://www.youtube.com/watch?v=y09VbdQWvQY">使用市场中的环境</a>
                </li>
                <li class="">
                    
    <a class="" href="https://github.com/simondlevy/AirSimTensorFlow">简单的碰撞规避算法</a>
                </li>
                <li class="">
                    
    <a class="" href="https://aka.ms/AutonomousDrivingCookbook">在Azure上的自动驾驶</a>
                </li>
                <li class="">
                    
    <a class="" href="https://github.com/Microsoft/AirSim/wiki/hexacopter">建设Hexacopter</a>
                </li>
                <li class="">
                    
    <a class="" href="https://github.com/Microsoft/AirSim/wiki/moveOnPath-demo">按路径移动演示</a>
                </li>
                <li class="">
                    
    <a class="" href="https://github.com/Microsoft/AirSim/wiki/Point-Clouds">构建点云</a>
                </li>
                <li class="">
                    
    <a class="" href="https://github.com/Microsoft/AirSim/wiki/Implementing-a-Drone-Survey-script">使用无人机进行测量</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">杂项</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../custom_drone/">真实无人机上的AirSim</a>
                </li>
                <li class="">
                    
    <a class="" href="../cmake_linux/">在Linux上安装cmake</a>
                </li>
                <li class="">
                    
    <a class="" href="../hard_drive/">关于非固体硬盘的建议</a>
                </li>
                <li class="">
                    
    <a class="" href="../pfm/">pfm格式</a>
                </li>
                <li class="">
                    
    <a class="" href="../unreal_proj/">设置虚幻环境</a>
                </li>
                <li class="">
                    
    <a class="" href="../unreal_blocks/">Blocks环境</a>
                </li>
                <li class="">
                    
    <a class="" href="../who_is_using/">谁在使用AirSim</a>
                </li>
                <li class="">
                    
    <a class="" href="../working_with_plugin_contents/">使用UE插件内容</a>
                </li>
                <li class="">
                    
    <a class="" href="https://github.com/Microsoft/AirSim/wiki/technion">方程式赛车的自动驾驶</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">Support</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../faq/">FAQ</a>
                </li>
                <li class="">
                    
    <a class="" href="../SUPPORT/">支持</a>
                </li>
                <li class="">
                    
    <a class="" href="../create_issue/">在GitHub上创建Issue</a>
                </li>
                <li class="">
                    
    <a class="" href="../CONTRIBUTING/">贡献</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">AirSim中文文档</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>他人贡献的教程 &raquo;</li>
        
      
    
    <li>强化学习</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/FrendoWu/AirSim-docs-zh/edit/master/docs/reinforcement_learning.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="reinforcement-learning-in-airsim">Reinforcement Learning in AirSim</h1>
<p>We below describe how we can implement DQN in AirSim using CNTK. The easiest way is to first install python only CNTK (<a href="https://docs.microsoft.com/en-us/cognitive-toolkit/setup-windows-python?tabs=cntkpy22">instructions</a>).</p>
<p>CNTK provides several demo examples of <a href="https://github.com/Microsoft/CNTK/tree/master/Examples/ReinforcementLearning">deep RL</a>. We will modify the DeepQNeuralNetwork.py to work with AirSim. We can utilize most of the classes and methods corresponding to the DQN algorithm. However, there are certain additions we need to make for AirSim.</p>
<h4 id="disclaimer">Disclaimer</h4>
<p>This is still in active development. What we share below is a framework that can be extended and tweaked to obtain better performance.</p>
<h2 id="rl-with-car">RL with Car</h2>
<p><a href="https://github.com/Microsoft/AirSim/tree/master/PythonClient//car/DQNcar.py">Source code</a></p>
<p>This example works with AirSimNeighborhood environment available in <a href="https://github.com/Microsoft/AirSim/releases">releases</a>.</p>
<p>First, we need to get the images from simulation and transform them appropriately. Below, we show how a depth image can be obtained from the ego camera and transformed to an 84X84 input to the network. (you can use other sensor modalities, and sensor inputs as well – of course you’ll have to modify the code accordingly).</p>
<pre><code>responses = client.simGetImages([ImageRequest(0, AirSimImageType.DepthPerspective, True, False)])
current_state = transform_input(responses)
</code></pre>

<p>We further define the six actions (breaking, straight with throttle, full-left with throttle, full-right with throttle, half-left with throttle, half-right with throttle) that an agent can execute. This is done via the function <code>interpret_action</code>:</p>
<pre><code>def interpret_action(action):
    car_controls.brake = 0
    car_controls.throttle = 1
    if action == 0:
        car_controls.throttle = 0
        car_controls.brake = 1
    elif action == 1:
        car_controls.steering = 0
    elif action == 2:
        car_controls.steering = 0.5
    elif action == 3:
        car_controls.steering = -0.5
    elif action == 4:
        car_controls.steering = 0.25
    else:
        car_controls.steering = -0.25
    return car_controls
</code></pre>

<p>We then define the reward function in <code>compute_reward</code> as a convex combination of how fast the vehicle is travelling and how much it deviates from the center line. The agent gets a high reward when its moving fast and staying in the center of the lane.</p>
<pre><code>def compute_reward(car_state):
    MAX_SPEED = 300
    MIN_SPEED = 10
    thresh_dist = 3.5
    beta = 3

    z = 0
    pts = [np.array([0, -1, z]), np.array([130, -1, z]), np.array([130, 125, z]), np.array([0, 125, z]), np.array([0, -1, z]), np.array([130, -1, z]), np.array([130, -128, z]), np.array([0, -128, z]), np.array([0, -1, z])]
    pd = car_state.position
    car_pt = np.array(list(pd.values()))

    dist = 10000000
    for i in range(0, len(pts)-1):
        dist = min(dist, np.linalg.norm(np.cross((car_pt - pts[i]), (car_pt - pts[i+1])))/np.linalg.norm(pts[i]-pts[i+1]))

    #print(dist)
    if dist &gt; thresh_dist:
        reward = -3
    else:
        reward_dist = (math.exp(-beta*dist) - 0.5)
        reward_speed = (((car_state.speed - MIN_SPEED)/(MAX_SPEED - MIN_SPEED)) - 0.5)
        reward = reward_dist + reward_speed

    return reward
</code></pre>

<p>The function <code>isDone</code> determines if the episode has terminated (e.g. due to collision). We look at the speed of the vehicle and if it is less than a threshold than the episode is considered to be terminated.</p>
<pre><code>def isDone(car_state, car_controls, reward):
    done = 0
    if reward &lt; -1:
        done = 1
    if car_controls.brake == 0:
        if car_state.speed &lt;= 5:
            done = 1
    return done
</code></pre>

<p>The main loop then sequences through obtaining the image, computing the action to take according to the current policy, getting a reward and so forth.
If the episode terminates then we reset the vehicle to the original state via: </p>
<pre><code>client.reset()
client.enableApiControl(True)
client.armDisarm(True)
car_control = interpret_action(1) // Reset position and drive straight for one second
client.setCarControls(car_control)
time.sleep(1)
</code></pre>

<p>Note that the simulation needs to be up and running before you execute DQNcar.py. The video below shows first few episodes of DQN training.</p>
<p><a href="https://youtu.be/fv-oFPAqSZ4"><img alt="Reinforcement Learning - Car" src="../images/dqn_car.png" /></a></p>
<h2 id="rl-with-quadrotor">RL with Quadrotor</h2>
<p><a href="https://github.com/Microsoft/AirSim/tree/master/PythonClient//multirotor/DQNdrone.py">Source code</a></p>
<p>This example works with AirSimMountainLandscape environment available in <a href="https://github.com/Microsoft/AirSim/releases">releases</a>.</p>
<p>We can similarly apply RL for various autonomous flight scenarios with quadrotors. Below is an example on how RL could be used to train quadrotors to follow high tension power lines (e.g. application for energy infrastructure inspection).
There are seven actions here that correspond to different directions in which the quadrotor can move in (six directions + one hovering action).</p>
<pre><code>def interpret_action(action):
    if action == 0:
        quad_offset = (0, 0, 0)
    elif action == 1:
        quad_offset = (1, 0, 0)
    elif action == 2:
        quad_offset = (0, 1, 0)
    elif action == 3:
        quad_offset = (0, 0, 1)
    elif action == 4:
        quad_offset = (-1, 0, 0)    
    elif action == 5:
        quad_offset = (0, -1, 0)
    elif action == 6:
        quad_offset = (0, 0, -1)
    return quad_offset
</code></pre>

<p>The reward again is a function how how fast the quad travels in conjunction with how far it gets from the known powerlines.</p>
<pre><code>def compute_reward(quad_state, quad_vel, collision_info):
    thresh_dist = 10
    beta = 1

    z = -10
    pts = [np.array([0, 0, z]), np.array([130, 0, z]), np.array([130, 125, z]), np.array([0, 125, z]), np.array([0, 0, z]), np.array([130, 0, z]), np.array([130, -128, z]), np.array([0, -128, z]), np.array([0, 0, z])]
    quad_pt = np.array(list((quad_state.x_val, quad_state.y_val, quad_state.z_val)))

    if collision_info.has_collided:
        reward = -100
    else:    
        dist = 10000000
        for i in range(0, len(pts)-1):
            dist = min(dist, np.linalg.norm(np.cross((quad_pt - pts[i]), (quad_pt - pts[i+1])))/np.linalg.norm(pts[i]-pts[i+1]))

        if dist &gt; thresh_dist:
            reward = -10
        else:
            reward = 2*(0.5 - math.exp(-beta*dist)) + np.linalg.norm([quad_vel.x_val, quad_vel.y_val, quad_vel.z_val])

    return reward
</code></pre>

<p>We consider an episode to terminate if it drifts too much away from the known power line coordinates. </p>
<p>The reset function here flies the quadrotor to the initial starting point:</p>
<pre><code>    if done:
        client.moveToZAsync(clearZ, 2).join()
        client.moveToPositionAsync(initX, initY, clearZ, 2).join()
        client.moveToPositionAsync(initZ, initY, initZ, 2).join()
        current_step +=1
</code></pre>

<p>Here is the video of first few episodes during the training.</p>
<p><a href="https://youtu.be/uKm15Y3M1Nk"><img alt="Reinforcement Learning - Quadrotor" src="../images/dqn_quadcopter.png" /></a></p>
<h2 id="related">Related</h2>
<p>Please also see <a href="https://aka.ms/AutonomousDrivingCookbook">The Autonomous Driving Cookbook</a> by Microsoft Deep Learning and Robotics Garage Chapter.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../custom_drone/" class="btn btn-neutral float-right" title="真实无人机上的AirSim">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../upgrade_settings/" class="btn btn-neutral" title="更新设置"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/FrendoWu/AirSim-docs-zh/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
        <span><a href="../upgrade_settings/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../custom_drone/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
